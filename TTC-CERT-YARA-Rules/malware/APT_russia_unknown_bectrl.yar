import "pe"

rule russia_unknown_PwmTower : T1574_002
{
	meta:		
		version = "1.1"
		first_imported = "2022-03-16"
		last_modified = "2022-09-04"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect PwmTower.exe (Legitimate File), should be checked if found in %ProgramData%"
		category = "TECHNIQUE"
		technique = "DLL Side-Loading"
		mitre_att = "T1574.002"
		hash = "B4A1B1BBE81EF14F8C25BFE1088B4E4BE8A7072C5879504EFF81504EB7620C01"

		
	strings:
		$s1 = "a68dcfc089b02e370438fd8b96299dfca7ede296" wide nocase
		$s2 = "GOOGLEUPDATEAPPLICATIONCOMMANDS" wide nocase
		$s3 = "nw.exe" ascii nocase 
		
	condition:
		all of ($s*) and
		uint16(0) == 0x5A4D and
		filesize <= 1MB
}

rule russia_unknown_nw_elf
{
	meta:
		version = "1.0"
		first_imported = "2022-03-16"
		last_modified = "2022-03-16"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect nw_elf.dll (Legitimate File), should be checked if found in %ProgramData%"
		category = "TECHNIQUE"
		technique = "DLL Side-Loading"
		mitre_att = "T1574.002"
		hash = "86140E6770FBD0CC6988F025D52BB4F59C0D78213C75451B42C9F812FE1A9354"
		
	strings:
		$s1 = "E:\\build\\nw20_sdk_win32\\node-webkit\\src\\outst\\nw\\nw_elf.dll.pdb" wide nocase
		$s2 = "SOFTWARE\\nwjs\\BLBeacon" wide nocase
		$s3 = "nw_elf.dll" ascii wide nocase
		$s4 = "\\\\.\\pipe\\crashpad_%d_" ascii wide nocase
		$s5 = "a68dcfc089b02e370438fd8b96299dfca7ede296" ascii wide nocase
		
	condition:
		3 of ($s*) and
		uint16(0) == 0x5A4D and
		filesize <= 500KB
}

rule russia_unknown_cryptor_nw_dll : T1574_002 T1027_002
{
	meta:
		version = "1.0"
		first_imported = "2022-03-16"
		last_modified = "2022-03-16"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect nw.dll (Packed), should be checked if found in %ProgramData%"
		category = "MALWARE"
		malware = "Cryptor, Launcher"
		technique = "DLL Side-Loading, Software Packed"
		mitre_att = "T1574.002, TT1027.002"
		hash = "52FB51BC93193430DF8254A36234E81FE8CD4293063F5A7CA94906156104391A"
		
	strings:
		$s1 = "nw.dll" nocase
		$s2 = ".MPRESS1" nocase
		
	condition:
		all of them and
		pe.characteristics & pe.DLL and
		filesize <= 2MB and
		pe.exports("NvSmartMaxSetState")
}

rule russia_unknown_payload1 : T1055
{
	meta:
		version = "1.1"
		first_imported = "2022-03-16"
		last_modified = "2022-09-04"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect decrypted_payload from nw.dll file in memory"
		category = "MALWARE"
		malware = "Trojan"
		technique = "Process Injection"
		mitre_att = "T1055"
		hash = "845D7963A6B5EA94CBE90500EA76A3C48B5D0C935B90FC9D925DD2B257E43B2C"
		
	strings:
		$s1 = "ResideVirtual" ascii wide nocase //Part of mutex
		$s2 = "TabletPCInputServices" ascii wide nocase //Schedule Task Name
		$s3 = "askg-9dwkaJU90TAE4320-FOKE904116FSAG156JEWG"
		$h1 = {68 88 BE ?? ?? 68 B4 BE ?? ??} //push $s3 string
	
	condition:
		(2 of ($s*) or $h1)
		and uint16(0) == 0x5A4D
		and for any section in pe.sections : ( section.name == ".Fun" )
}

rule russia_unknown_Brcc32 : T1574_002
{
	meta:
		version = "1.0"
		first_imported = "2022-03-16"
		last_modified = "2022-03-16"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect brcc32.exe (Legitimate File), should be checked if found in %Windows%\\Help\\Help"
		category = "TECHNIQUE"
		technique = "DLL Side-Loading"
		mitre_att = "T1574.002"
		hash = "2AACF66D78E284729C3CA0DA6C260FA3A95FF61AAE6527D6DC4500AD7DAA1E63"
		
	strings:
		$s1 = "BRCC32.EXE" ascii wide nocase
		$s2 = "StaticApiRegister" nocase
		$s3 = "Borland Resource Compiler" ascii wide nocase 
		
	condition:
		all of ($s*) and
		uint16(0) == 0x5A4D and
		filesize <= 200KB
}

rule russia_unknown_cryptor_rw32core_dll : T1574_002 TT1027_002
{
	meta:
		version = "1.1"
		first_imported = "2022-03-16"
		last_modified = "2022-09-04"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect rw32core.dll used for DLL Side-loading by brcc32.exe located in %Windows%\\Help\\Help"
		category = "MALWARE"
		malware = "Cryptor, Launcher"
		technique = "DLL Side-Loading, Software Packed"
		mitre_att = "T1574.002, TT1027.002"
		hash = "3CDFE80DAEE2DEC7044CEBDAB6FD73C4C91AE3EE6703CDFDC374576087ECF5E6"
		
	strings:
		$s1 = "rw32core.dll" nocase
		$s2 = "sjg98oji4tp0-fposdJDSIOGOPSDFGOEW824PIGR165G6" ascii wide nocase //Part of XOR key
		$h1 = {68 90 28 00 00 68 60 38 ?? ?? 8D 88 EA 6D} //shellcode's size and baseaddress using by WriteProcessMemory
	
	condition:
		(all of ($s*) or $h1)
		and filesize <= 1000KB and filesize >= 800KB //comment this line if want to check the memory
		and pe.characteristics & pe.DLL
		and pe.exports("NvSmartMaxSetState")
}

rule russia_unknown_payload2 : T1055
{
	meta:
		version = "1.1"
		first_imported = "2022-03-16"
		last_modified = "2022-09-04"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect decrypted_payload from rw32core.dll file in memory"
		category = "MALWARE"
		malware = "Trojan"
		technique = "Process Injection"
		mitre_att = "T1055"
		hash = "C40B0C89C2FCEE6E52FBD7C1B0B2DBD476E4DCBA2B04F3C2981BCF56268A29C9"
		
	strings:
		$s1 = "Start Clnt program error!" ascii wide nocase
		$s2 = "StartBeCtrlAsUser Error!" ascii wide nocase
		$s3 = "read_pipe_session" ascii wide nocase
		$s4 = "wirte_pipe_session" ascii wide nocase
		$s5 = "key:" ascii wide nocase
		$s6 = "DemeterID" ascii wide nocase
	
	condition:
		3 of ($s*)
		and uint16(0) == 0x5A4D
		and for any section in pe.sections : ( section.name == ".Config" )
}

rule russia_unknown_consent : T1574_002
{
	meta:
		version = "1.0"
		first_imported = "2022-03-16"
		last_modified = "2022-03-16"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect consent.exe (Legitimate File), should be checked if found in %Windows%\\Help\\Help"
		category = "TECHNIQUE"
		technique = "DLL Side-Loading"
		mitre_att = "T1574.002"
		hash = "33BFAA84E7543C9504B16113E0E0B16FAF3F117FC92FE4017F682E8E7D13B4FD"
		
	strings:
		$s1 = "consent.exe" ascii wide nocase
		$s2 = "consent.pdb" ascii wide nocase
		$s3 = "MICROSOFT_AUTHENTICATION_PACKAGE" ascii wide nocase 
		
	condition:
		all of ($s*)
		and uint16(0) == 0x5A4D
		and filesize <= 200KB
		and pe.number_of_signatures >= 1
		and for any s in (0..pe.number_of_signatures - 1): (
		pe.signatures[s].subject contains "Microsoft Corporation" )
}

rule russia_unknown_cryptor_secur32 : T1574_002 TT1027_002
{
	meta:		
		version = "1.1"
		first_imported = "2022-03-16"
		last_modified = "2022-09-04"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect Secur32.dll used for DLL Side-loading by consent.exe located in %Windows%\\Help\\Help"
		category = "MALWARE"
		malware = "Cryptor, Launcher"
		technique = "DLL Side-Loading, Software Packed"
		mitre_att = "T1574.002, TT1027.002"
		hash = "66B7983831CBB952CEEB1FFFF608880F1805F1DF0B062CEF4C17B258B7F478CE"
		
	strings:
		$ss1 = "Kern" //Stackstring
		$ss2 = "el32" //Stackstring
		$ss3 = "Virt" //Stackstring
		$ss4 = "ualA" //Stackstring
		$ss5 = "llocf" //Stackstring
		$ss6 = "PGRA9I0T4PRG09J9JT4KLFEWIFE-GPFELK" //Part of XOR key
		$h1 = {68 90 29 ?? ?? 68 60 38 ?? ?? 8D 88 AA 26} //shellcode's size and baseaddress using by WriteProcessMemory
	
	condition:
		(all of ($ss*) or $h1)
		and filesize <= 600KB and filesize >= 400KB //comment this line if want to check the memory
		and pe.characteristics & pe.DLL
		and pe.exports("NvSmartMaxSetState")
}

rule russia_unknown_payload3 : T1055
{
	meta:
		version = "1.0"
		first_imported = "2022-03-16"
		last_modified = "2022-03-16"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect decrypted_payload from secur32.dll file in memory"
		category = "MALWARE"
		malware = "Trojan"
		technique = "Process Injection"
		mitre_att = "T1055"
		hash = "E20752DA211B0577D5C551EFF49F1DC3146891EBCC5AF8BB3EBD5BBEBA111387"
		
	strings:
		$s1 = "cmd.exe /c " nocase
		$s2 = "/img_src/QScreen" nocase
		$s3 = "BeCtrl.exe" nocase
		$s4 = "TwoPipeShell" nocase
		$s5 = "OnePipeShell" nocase
		$s6 = "keyboardData" nocase
		$s7 = "Screen Start" nocase
		$s8 = "Screen Stop" nocase
		$s9 = "fkpioefpoea" //part of string
		$h1 = {68 6C D8 ?2 ?? 50 FF D6}
			/*
			push offset aCmdExeC_0
			push eax
			call easi ; lstrcatW
			*/
		$h2 = {05 01 00 00 40 50 51 FF 15 E0 80 ?2 ??} //determine OpenMode of CreateNamePipeA
	
	condition:
		6 of ($s*)
		and 1 of ($h*)
		and uint16(0) == 0x5A4D
		and pe.exports("DllGetClassObject")
}
