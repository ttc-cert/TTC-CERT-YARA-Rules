import "pe"
import "hash"

rule apt32_decoy_MS_WORD
{
	meta:
		version = "1.0"
		first_imported = "2021-04-23"
		last_modified = "2021-04-23"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect Decoy MS WORD file used by APT32 aka OceanLotus to hiject DLL loading (wwlib.dll) within the same directory"
		category = "TECHNIQUE"
		malware = "Decoy document, DLL Side-loading"
		hash = "6C959CFB001FBB900958441DFD8B262FB33E052342948BAB338775D3E83EF7F7"

	strings:
		$pdb = "t:\\word\\x86\\ship\\0\\winword.pdb"
		$s0 = "winword.exe" nocase
		$s1 = "Thawte Certification" nocase
              
	condition:
		all of them and
		uint16(0) == 0x5A4D and
		filesize >= 300KB and
		(pe.version_info["OriginalFilename"] contains "WinWord.exe" and
		pe.imphash() == "46337557842a2a62735bb11eb096b204")
}

rule apt32_DLL_Side_Loading
{
	meta:
		version = "1.0"
		first_imported = "2021-04-23"
		last_modified = "2021-04-23"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect wwlib.dll (Malicious) used by APT32 aka OceanLotus"
		category = "TECHNIQUE"
		malware = "DLL Side-loading, Cryptor"
		hash = "FA259F953CD319DA9BDCD84D40B2A89869BD307E8F9206B5653E78666F08F5B8"
       
	strings:
		$s1 = "DllHijack.dll" nocase
		$s2 = "office.doc" nocase
		$s3 = "NjQGb3gEbzk6NTlvFCkgR/5lY2tvLzIw1yICfTEgRmlyvVJveC/4HAAJAAAAAAAk/wA="
      
	condition:
		2 of them and
		filesize >= 100KB and
		(pe.characteristics & pe.DLL and
		pe.imphash() == "393639a60c6cd8a32838f37476501ec3")
}