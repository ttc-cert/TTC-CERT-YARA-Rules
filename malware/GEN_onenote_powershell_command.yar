rule SUSP_OneNote_Embedded_FileDataStoreObject_PowerShell_Command {
   meta:
      version = "1.0"
      first_imported = "2023-02-10"
      last_modified = "2023-02-10"
      status = "RELEASED"
      sharing = "TLP:CLEAR"
      source = "Manual investigate"
      author = "TTC-CERT"
      description = "Detects suspicious embedded PowerShell command in OneNote files"
      category = "TECHNIQUE"
      technique = "User Execution: Malicious File"
      mitre_att = "T1204.002"
      hash = "62a0750ae87bd6445ebc202e442b0820c859507be37487e012b910660050929a"
   strings:
      /* GUID FileDataStoreObject https://blog.didierstevens.com/ */
      $a1 = { 00 e7 16 e3 bd 65 26 11 45 a4 c4 8d 4d 0b 7a 9e ac }
      $s1 = "powershell " nocase
      $s2 = "FromBase64String" nocase
   condition:
      filesize < 5MB
      and $a1 
      and 1 of ($s*)
}
