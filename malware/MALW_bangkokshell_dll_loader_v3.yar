import "pe"

rule bangkokshell_dll_loader_v3
{

	meta:
		version = "1.2"
		first_imported = "2023-12-01"
		last_modified = "2023-12-01"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect Loader V3 (as tracked by TTC-CERT) used in the BangkokShell operation, which deobfuscates the shellcode and injects it into memory."
		hash = "14ea8e3ea8cac0330b6c9c43c9046103758fe7ea816c6241196f3df00e01345f "
		
	strings:		
		$stackstring =
			{
				89 (45 | 5D | 4D | 55 | 75 | 7D | 85 | 9D | 8D | 95 | B5 | BD) (?? | ?? ?? ?? ?? )	
				(B8 | B9 | BA | BB | BE | BF) 01 00 00 00											
				(6B (C? | D? | F?) ?? | C1 (E0 | E1 | E2 | E3 | E6 | E7) (0? | 1?))					
				C6 44 (0D | 05 | 1D | 15 | 35 | 3D)													
			}
			
		$copy_data_to_mem =
			{
				(B8 | B9 | BA | BB | BE | BF) 01 00 00 00								
				(6B (C? | D? | F?) ?? | C1 (E0 | E1 | E2 | E3 | E6 | E7) (0? | 1?))		
				8B (45 | 5D | 4D | 55 | 75 | 7D) 08										
				0F B6 (04 | 1C | 0C | 14 | 34 | 3C) ??									
				89 (45 | 5D | 4D | 55 | 75 | 7D) FC										
			}
			
		$RC4_prologue = 
			{
				83 C? 01			
				(81 E? | 25) FF 00 00 ?0	
				79 ??				
				(48 | 4B | 49 | 4A | 4E | 4F)	
				(81 C? | 0D) 00 FF FF FF	
				(40 | 43 | 41 | 42 | 46 | 47)	
			}
		
		$call_instruction =
			{
				8B (55 ?? | 95 ?? ?? ?? ??)	
				89 (55 ?? | 95 ?? ?? ?? ??)	
				8B (45 ?? | 85 ?? ?? ?? ??)	
				83 E8 04			
				50				
				8B (4D ?? | 8D ?? ?? ?? ??)	
				83 C1 04			
				51				
				8D (55 ?? | 95 ?? ?? ?? ??)	
				52				
				8B (45 ?? | 85 ?? ?? ?? ??)	
				50				
			}
		
	condition:
		(pe.is_pe or pe.is_dll())
		and (filesize >= 50KB and filesize <= 1MB)
		and 2 of them
}
