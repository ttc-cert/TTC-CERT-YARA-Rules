rule bangkokshell_trishul_rat
{
	meta:
		version = "1.2"
		first_imported = "2023-12-29"
		last_modified = "2023-02-05"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect Trishul RAT, a Shellcode Remote Access Trojan used in BangkokShell operation."
		hash = "18db413bd1b030f6838ba35057bc03e7bacc7fbe9d0c25156010fe2543d5e571"
		
	strings:
		$cap_interval_sleep = 
			{
				6A 04			
				8B 55 0C		
				52			
				8B 45 ??		
				05 A0 03 00 00	
				50			
				E8 [4]			
				83 C4 ??		
				C7 45 ?? 01 00 00 00	
				E9			
			}
		$cap_inject_code =
			{
				C7 45 ?? 00 00 00 00	
				8D 4D ??		
				51			
				6A 40			
				8B 55 10		
				52			
				8B 45 0C		
				50			
				8B 4D FC		
				8B 11			
				8B 42 ??		
				FF D0			
				8B 4D 0C		
				89 4D ??		
				FF 55 ??		
				C7 45 ?? 01 00 00 00	
				EB			
			}
		$xor_op = 
			{
				8B 45 08		
				03 45 ??		
				0F B6 08		
				8B 45 ??		
				83 C0 ??		
				8B 75 14		
				83 EE ??		
				33 D2			
				F7 F6			
				8B 45 10		
				0F B6 14 10		
				33 CA			
				8B 45 08		
				03 45 ??		
				88 08			
				EB			
			}
		$cap_cmd = 
			{
				C7 45 ?? 01 01 00 00	
				C6 45 ?? 63		
				C6 45 ?? 6D		
				C6 45 ?? 64		
				C6 45 ?? 2E		
				C6 45 ?? 65		
				C6 45 ?? 78		
				C6 45 ?? 65		
				C6 45 ?? 20		
				C6 45 ?? 2F		
				C6 45 ?? 63		
				C6 45 ?? 20		
			}
		$prep_mem_call =
			{
				(6A ??	| 68 ?? ?? 00 00)	
				6A 00				
				(8D 45 ?? | 8d 85 ?? ?? ff ff)	
				50				
				E8 [2] FF FF			
				83 C4 0C			
			}
		$prep_mem =
			{
				8B 55 08			
				03 55 FC			
				8A 45 0C			
				88 02				
				EB				    
			}
	
	condition:
		any of ($cap_*)
		and ($xor_op
			or (#prep_mem_call > 4 and $prep_mem))
}
