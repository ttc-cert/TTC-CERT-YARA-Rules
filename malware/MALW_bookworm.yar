import "pe"

rule bookworm_dropper : MSI POWERSHELL
{
	meta:
		version = "1.1"
		first_imported = "2022-11-25"
		last_modified = "2022-12-08"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Bookworm malware use MSI file to drop legitimate file and malicious DLL onto filesystem, also the MSI file contain powershell loader and will send the beacon to C2"
		category = "TECHNIQUE"
		technique = "SYSTEM BINARY PROXY EXECUTION:MSIEXEC"
		mitre_att = "T1218.007"
		hash = "5149f8fb28a8bf2a67e22de1e781e88b1094a6904e676ff0e74a08278e6e37c2"

	strings:
		$s1 = "libcurl.dll" ascii wide nocase private
		$s2 = "Windows Installer" ascii wide private
		$s3 = "CustomAction" ascii wide private
		$s4 = "Invoke-WebRequest -URI" ascii wide nocase private
		$p1 = "Say-Hello()" ascii wide nocase private
		$p2 = "Let's see which Powershell we're using. Feel free to remove this function" ascii wide nocase private
		$p3 = "e.g. in a username. We need to enclose each bundle of them in a simple quoted" ascii wide nocase private
		$m1 = "MicrosoftAssistantUpdateTaskMachine" ascii wide nocase private
		$m2 = /\.[0-9a-z]{4,63}\.eu\.org/ ascii wide nocase //Beacon C2
	
	condition:
		uint32(0) == 0xE011CFD0
		and (filesize >= 2MB and filesize <= 4MB)
		and all of ($s*)
		and 1 of ($p*)
		and 1 of ($m*)
}

rule bookworm_dll_UUID : dll_side_loading UUID
{
	meta:
		version = "1.0"
		first_imported = "2022-11-25"
		last_modified = "2022-11-25"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Bookworm malware use DLL Side-Loading technique to load malicious DLL file which contain UUID shellcode and execute the shellcode in memory"
		category = "TECHNIQUE"
		technique = "PROCESS INJECTION:SHELLCODE"
		mitre_att = "T1055"
		hash = "a2452456eb3a1a51116d9c2991aae3b0982acc1a9b30efee92a4f102dc4d2927"

	strings:
		$uuid = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/ ascii wide private
		$winapi_1 = "EnumSystemLanguageGroupsA" //This API could be used to execute UUID shellcode
		$winapi_2 = "EnumSystemLocalesA" //This API could be used to execute UUID shellcode

	condition:
		uint16(0) == 0x5A4D
		and (filesize >= 500KB and filesize <= 2MB)
		and ($winapi_1 or $winapi_2)
		and #uuid > 1000
}

rule bookworm_UUID_shellcode : UUID_shellcode
{
	meta:
		version = "1.0"
		first_imported = "2022-11-25"
		last_modified = "2022-11-25"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Bookworm inject shellcode into host's process memory, use this yara to detect shellcode running in memory"
		category = "TECHNIQUE"
		technique = "PROCESS INJECTION:SHELLCODE"
		mitre_att = "T1055"

	strings:
		$shell1 = { 8B C2 D3 E8 A8 01 ?? ?? 41 83 F9 08 } //custom decryption algorithm used to decrypt key for using with RC4
			/*
			mov     eax, edx
			shr     eax, cl
			test    al, 1
			jz      short
			inc     ecx
			cmp     ecx, 8
			*/
		$shell2 = { B8 08 08 [0-2] 0D 00 00 01 [0-1] 50 } //parameter for payload#1 at offset 0x7D0
			/*
			mov		eax,808
			or		eax,10000
			push	eax
			*/
		$shell3 = { C7 45 D4 4C 6F 61 64 C7 45 D8 4C 69 62 72 C7 45 DC 61 72 79 41 } //stack strings
			/*
			mov		dword ptr ss:[ebp-2C],64616F4C
			mov		dword ptr ss:[ebp-28],7262694C
			mov		dword ptr ss:[ebp-24],41797261
			*/

	condition:
		2 of them
}