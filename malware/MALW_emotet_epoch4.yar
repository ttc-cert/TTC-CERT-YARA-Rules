import "pe"

rule emotet_epoch4_doc_binary_padding : T1027_001 S0367
{
	meta:
		version = "1.0"
		first_imported = "2023-03-09"
		last_modified = "2023-03-09"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect Microsoft Office file using binary padding technique to create large suspicious file size, threat actors usually embedded DOC file with macro which will download and install Emotet epoch4"
		hash = "cb638551632b271c9993266834e78a2c9a64a4b9deb8590497b0901f1044e6ff"
	strings:
		$doc_footer = {F4 39 B2 71}
		$str1 = "AutoOpen" fullword
	condition:
		(uint32(0) == 0xE011CFD0 or uint32(0) == 0x04034B50)
		and (filesize >= 100MB and filesize <= 800MB)
		and ($str1 and not $doc_footer in (filesize-414..filesize-410))
}

rule emotet_epoch4_dll_binary_padding : T1027_001 S0367
{
	meta:
		version = "1.0"
		first_imported = "2023-03-09"
		last_modified = "2023-03-09"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect Emotet Epoch4 dll file using binary padding technique to create large binary file size"
		hash = "9a358c9a72d4c083975ad07939cc61be864d87dc31370be86ad25cfc38f6b5e4"
	strings:
		$str1 = "memory has been allocated prior to heap redirector hook!" ascii wide nocase
		$str2 = "Embarcadero RAD Studio 27.0" ascii wide nocase
		$str3 = "tst1.dll" ascii wide nocase
		$str4 = "PLATFORMTARGETS" ascii wide
		$str5 = "com.embarcadero" wide fullword nocase
		$str6 = "releaseHeap" ascii wide
	condition:
		pe.is_dll()
		and (filesize >= 100MB)
		and 5 of them
}