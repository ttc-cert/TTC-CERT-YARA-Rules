import "pe"

rule emotet_epoch4_doc_binary_padding : T1027_001 S0367
{
	meta:
		version = "1.1"
		first_imported = "2023-03-09"
		last_modified = "2023-03-10"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect Microsoft Office file using binary padding technique to create large suspicious file size, threat actors usually embedded DOC file with macro which will download and install Emotet epoch4"
		reference = "Derived strings in ($auto*) and ($macro*) from David Bernal's YARA rule"
		hash = "cb638551632b271c9993266834e78a2c9a64a4b9deb8590497b0901f1044e6ff"
	strings:
		$doc_footer = {F4 39 B2 71}
		$auto1 = "AutoOpen" fullword
		$auto2 = "AutoClose" fullword
		$macro1 = "ThisDocument"
		$macro2 = "Project"
	condition:
		(uint32(0) == 0xE011CFD0 or uint32(0) == 0x04034B50)
		and (filesize >= 100MB and filesize <= 800MB)
		and not $doc_footer in (filesize-414..filesize-410)
		and all of ($macro*)
		and 1 of ($auto*)
}

rule emotet_epoch4_dll_binary_padding : T1027_001 S0367
{
	meta:
		version = "1.1"
		first_imported = "2023-03-09"
		last_modified = "2023-03-10"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect Emotet Epoch4 dll file using binary padding technique to create large binary file size"
		hash = "9a358c9a72d4c083975ad07939cc61be864d87dc31370be86ad25cfc38f6b5e4"
	strings:
		$str1 = "PLATFORMTARGETS" ascii wide
		$str2 = "com.embarcadero." wide nocase
	condition:
		pe.is_dll()
		and (filesize >= 100MB)
		and all of them
		and for any section in pe.sections : ( section.name == ".tls" and section.raw_data_size == 1536)
		and pe.overlay.size > 100000000
}