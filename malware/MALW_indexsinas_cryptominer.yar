import "pe"

rule indexsinas_launcher_unpacked : Dropper Launcher
{
	meta:
		version = "1.0"
		first_imported = "2021-10-28"
		last_modified = "2021-10-28"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect 32.exe (Unpacked) malware used in Indexsinas campaign"
		category = "MALWARE"
		malware = "Dropper and Launcher"
		hash = "424C292022BA1286041390A704086C7250D596BBD8D412C6E7472D6D1413E517"

	strings:
		$s1 = "MAIN" nocase wide ascii
		$s2 = "ld.bat" wide ascii
		$s3 = "lb.bat" wide ascii
		$s4 = "neibu.bat" wide ascii
		$path = "C:\\Windows\\Fonts\\Ms" nocase wide ascii
			/*
			81 7B 14 34 12 DE C0 cmp dword ptr [ebx+14h], 0C0DE1234h
			0F 85 4D 05 00 00 jnz loc_40FCF5
			*/
			//Check if resource already dropped then jump to the end of function
		$hex1 = {81 7B 14 34 12 DE C0 0F 85 4D 05 00 00}
			/*
			6A 02 push 2
			68 64 43 40 00 push offset Name
			A1 84 AB 40 00 mov eax, hModule
			50 push eax
			*/
			//Locate resource
		$hex2 = {6A 02 68 64 43 40 00 A1 84 AB 40 00 50}
			/*
			50 push eax
			6A 01 push 1
			6A 00 push 0
			6A 00 push 0
			68 00 00 00 40 push 40000000h
			8D 85 80 FB FF FF lea eax, [ebp+var_480]
			50 push eax
			FF 57 38 call dword ptr [edi+38h]
			*/
			//Arguments for CreateFileW
		$hex3 = {68 00 00 00 40 8D 85 80 FB FF FF 50 FF 57 38}

	condition:
		uint16(0) == 0x5A4D
		and 3 of ($s*)
		and $path
		and 2 of ($hex*)
}

rule indexsinas_backdoor_RAT : Backdoor RAT
{
	meta:
		version = "1.0"
		first_imported = "2021-10-28"
		last_modified = "2021-10-28"
		status = "RELEASED"
		sharing = "TLP:WHITE"
		source = "https://www.ttc-cert.or.th"
		author = "TTC-CERT"
		description = "Detect RAT file used in Indexsinas campaign, also known as Gh0stCringe"
		category = "MALWARE"
		malware = "Remote Access Trojan"
		hash = "309B9F57044AFD1C8B0E0381DA3E54CDD3F45AAFD924BFBFF2FD1D5AA0166E48"

	strings:
		$s1 = "Magentservices" nocase wide ascii
		$s2 = "CWzdDoc" nocase wide ascii
		$s3 = "CWzdView" nocase wide ascii
		$s4 = "site.indonesia.website" nocase wide ascii

	condition:
		3 of ($s*)
		and uint16(0) == 0x5A4D
		and filesize > 100KB and filesize < 200KB
		and pe.imports("mfc42.dll")
}