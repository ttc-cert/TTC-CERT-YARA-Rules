import "pe"
import "console"

rule pulse_cobaltstrike_sfx{
	meta:
		version = "1.0"
		first_imported = "2023-01-25"
		last_modified = "2023-01-25"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect fake Pulse secure update file, this is the SFX file with huge overlay used to drop malicious file into %AppData%, create schedule task, and execute powershell."
		hash = "ac0221a25162c259472ad3c5d4d31274fb14d8a14c8b0bbf4af015fbe0a113a7"
	strings:
		$sfx = "WinRAR self-extracting archive" wide ascii nocase
		$str1 = "Presetup=schtasks /create /tn" wide ascii nocase //script to create schedule task
		$str2 = "ExecutionPolicy Bypass Add-MpPreference" wide ascii nocase //script to execute powershell
		$str3 = "d:\\projects\\winrar\\sfx\\build\\sfxzip32\\release\\sfxzip.pdb" wide ascii nocase
		$file1 = "libcurl.dll"
		$file2 = "gup.xml"
		$file3 = "JuniperSetup.exe" nocase
		$file4 = "Juniper.exe" nocase
	condition:
		uint16(0) == 0x5A4D
		and (filesize >= 2MB and filesize <= 4MB)
		and pe.overlay.size > 2000000
		and ($sfx and 2 of ($str*) and 2 of ($file*))
}

rule pulse_cobaltstrike_beacon_loader{
	meta:
		version = "1.0"
		first_imported = "2023-01-25"
		last_modified = "2023-01-25"
		status = "RELEASED"
		sharing = "TLP:CLEAR"
		source = "Manual investigate"
		author = "TTC-CERT"
		description = "Detect malicious libcurl.dll (packed) dropped by fake Pulse secure update SFX file and will be used in DLL Side-loading technique. Caution! this rule may has high false positive rate, please keep looking for malicious libcurl.dll file which located in the same directory with file named 'Juniper.exe' (original file name gup.exe)"
		hash = "092e11dcd80157f00cb0b9ebede6638645344994a2d80d26dc44c2043828fa67"
	condition:
		pe.characteristics & pe.DLL
		and pe.version_info["OriginalFilename"] contains "libcurl.dll"
		and pe.sections[0].name == "UPX0"
		and pe.timestamp >= 1642480842
		and (filesize >= 200KB and filesize <= 1MB)
		and console.log("### High confidence if found Juniper.exe located in the same directory ###")
}